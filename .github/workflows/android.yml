name: Android Release

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install web deps
        run: |
          if [ -f pnpm-lock.yaml ]; then
            corepack enable
            pnpm i --frozen-lockfile
          elif [ -f yarn.lock ]; then
            yarn --frozen-lockfile
          elif [ -f package-lock.json ]; then
            npm ci --no-audit --no-fund
          else
            npm i --no-audit --no-fund
          fi

      - name: Prepare Capacitor assets dirs
        run: |
          mkdir -p android/app/src/main/assets/public
          ls -la android/app/src/main/assets || true

      - name: Capacitor sync (generate android plugins)
        run: npx cap sync android

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      # Keystore: restore if provided, otherwise generate one in CI
      - name: Ensure release keystore exists (restore or generate)
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          set -e
          mkdir -p android/app/keystore
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | base64 -d > android/app/keystore/fyndo-release.jks
            echo "Restored keystore from secret."
          else
            echo "No KEYSTORE_BASE64 secret; generating a new keystore..."
            keytool -genkeypair -v \
              -keystore android/app/keystore/fyndo-release.jks \
              -storetype JKS \
              -storepass "$KEYSTORE_PASSWORD" \
              -keypass "$KEY_PASSWORD" \
              -alias fyndo_release \
              -keyalg RSA -keysize 2048 -validity 36500 \
              -dname "CN=Fyndo, OU=Engineering, O=Eperom, L=Haifa, ST=Haifa, C=IL"
            base64 -w0 android/app/keystore/fyndo-release.jks > keystore.b64
          fi
          ls -la android/app/keystore

      - name: Make Gradle wrapper executable
        run: chmod +x android/gradlew

      # Force-sign the APK with injected props (works even if Gradle misses envs)
      - name: Assemble signed release (force-sign)
        working-directory: android
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          ./gradlew :app:clean :app:assembleRelease --no-daemon \
            -Pandroid.injected.signing.store.file="$PWD/app/keystore/fyndo-release.jks" \
            -Pandroid.injected.signing.store.password="${KEYSTORE_PASSWORD}" \
            -Pandroid.injected.signing.key.alias="fyndo_release" \
            -Pandroid.injected.signing.key.password="${KEY_PASSWORD}"

      # Also build the AAB and convert to a signed universal APK as fallback
      - name: Bundle signed release (force-sign)
        working-directory: android
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          ./gradlew :app:bundleRelease --no-daemon \
            -Pandroid.injected.signing.store.file="$PWD/app/keystore/fyndo-release.jks" \
            -Pandroid.injected.signing.store.password="${KEYSTORE_PASSWORD}" \
            -Pandroid.injected.signing.key.alias="fyndo_release" \
            -Pandroid.injected.signing.key.password="${KEY_PASSWORD}"

      - name: Make universal APK from AAB (signed fallback)
        run: |
          AAB="android/app/build/outputs/bundle/release/app-release.aab"
          if [ -f "$AAB" ]; then
            curl -L -o bundletool.jar https://github.com/google/bundletool/releases/download/1.15.6/bundletool-all-1.15.6.jar
            java -jar bundletool.jar build-apks \
              --bundle="$AAB" \
              --output=universal.apks \
              --mode=universal \
              --ks=android/app/keystore/fyndo-release.jks \
              --ks-pass=pass:${{ secrets.KEYSTORE_PASSWORD }} \
              --ks-key-alias=fyndo_release \
              --key-pass=pass:${{ secrets.KEY_PASSWORD }}
            unzip -p universal.apks universal.apk > android/app/build/outputs/bundle/release/app-release-universal.apk
          fi

      - name: List build outputs
        run: |
          echo "=== APKs ==="; ls -R android/app/build/outputs/apk || true
          echo "=== BUNDLE ==="; ls -R android/app/build/outputs/bundle || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-outputs
          path: |
            android/app/build/outputs/apk/release/*.apk
            android/app/build/outputs/bundle/release/*.aab
            android/app/build/outputs/bundle/release/app-release-universal.apk
            keystore.b64
          if-no-files-found: warn
